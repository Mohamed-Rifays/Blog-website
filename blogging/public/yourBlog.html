<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Blogs</title>

    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            background: #f5f5f7;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 900px;
            margin: 30px auto;
            padding: 0 20px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 25px;
        }

        .blog-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }

        .blog-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .posted-on {
            font-size: 0.9rem;
            color: #888;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .delete-btn {
            background: #ff4d4d;
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .delete-btn:hover {
            background: #e60000;
        }

        .edit-btn {
            background: #4a90e2;
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .edit-btn:hover {
            background: #357ab8;
        }

        .blog-card h2 {
            margin: 5px 0;
            color: #444;
        }

        .blog-card h3 {
            margin: 0 0 10px 0;
            color: #666;
            font-weight: normal;
        }

        .blog-card p {
            margin: 0;
            color: #555;
            line-height: 1.6rem;
        }

        .no-blogs {
            text-align: center;
            font-size: 1.2rem;
            margin-top: 40px;
            color: #777;
        }
    </style>
</head>

<body>
    <div class="container" id="my-blogs"></div>

    <script>
        async function loadMyBlogs() {
            const container = document.getElementById('my-blogs');
            const token = localStorage.getItem('token');

            if (!token) {
                container.innerHTML = `
                    <h1>My Blogs</h1>
                    <p class="no-blogs">You must be logged in to view your blogs.</p>
                `;
                return;
            }

            try {
                const req = await fetch('/blogs/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const blogs = await req.json();

                if (!blogs.length) {
                    container.innerHTML = `
                        <h1>My Blogs</h1>
                        <p class="no-blogs">You havenâ€™t created any blogs yet.</p>
                    `;
                    return;
                }

                container.innerHTML = `
                    <h1>My Blogs</h1>
                    ${blogs.map(blog => {
                        const date = new Date(blog.createdAt).toLocaleString();

                        return `
                            <div class="blog-card">
                                <div class="blog-header">
                                    <div class="posted-on">Posted on: ${date}</div>
                                    <div class="action-buttons">
                                        <button 
                                            class="edit-btn"
                                            onclick="editBlog(
                                                '${blog._id}',
                                                '${escapeHtml(blog.title)}',
                                                '${escapeHtml(blog.subtitle)}',
                                                '${escapeHtml(blog.content)}'
                                            )">
                                            Edit
                                        </button>
                                        <button 
                                            class="delete-btn"
                                            onclick="deleteBlog('${blog._id}')">
                                            Delete
                                        </button>
                                    </div>
                                </div>

                                <h2>${blog.title}</h2>
                                <h3>${blog.subtitle}</h3>
                                <p>${blog.content}</p>
                            </div>
                        `;
                    }).join('')}
                `;

            } catch (err) {
                container.innerHTML = `
                    <h1>My Blogs</h1>
                    <p class="no-blogs">Failed to load blogs.</p>
                `;
            }
        }

        async function deleteBlog(blogId) {
            const token = localStorage.getItem('token');

            if (!confirm('Are you sure you want to delete this blog?')) return;

            try {
                const res = await fetch(`/blogs/${blogId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (res.ok) {
                    alert('Blog deleted successfully');
                    loadMyBlogs();
                } else {
                    alert('Failed to delete blog');
                }
            } catch (err) {
                alert('Something went wrong');
            }
        }

        async function editBlog(id, oldTitle, oldSubtitle, oldContent) {
            const title = prompt('Edit title', oldTitle);
            const subtitle = prompt('Edit subtitle', oldSubtitle);
            const content = prompt('Edit content', oldContent);

            if (!title || !subtitle || !content) return;

            const token = localStorage.getItem('token');

            try {
                const res = await fetch(`/blogs/${id}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title,
                        subtitle,
                        content
                    })
                });

                if (res.ok) {
                    loadMyBlogs();
                } else {
                    alert('Update failed');
                }
            } catch (err) {
                alert('Something went wrong');
            }
        }

        // Prevent HTML breaking in inline onclick
        function escapeHtml(text) {
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        loadMyBlogs();
    </script>
</body>
</html>
